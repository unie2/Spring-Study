## âœ” í”„ë¡œì íŠ¸ ìƒì„±
### 1. Spring Initializr
![spring initializr](https://user-images.githubusercontent.com/54324782/222021464-d9b83fb5-3e97-42da-be75-94fedbedd258.png)

### 2. Run main() > localhost:8080 ì ‘ì†
![run](https://user-images.githubusercontent.com/54324782/222021632-c44c2123-d558-4c41-9ace-d0a88b486d90.png)

```
// ì£¼ì˜! - ìŠ¤í”„ë§ ë¶€íŠ¸ 3.0
ìŠ¤í”„ë§ ë¶€íŠ¸ 3.0ì„ ì„ íƒí•˜ê²Œ ë˜ë©´ ë‹¤ìŒ ë¶€ë¶„ì„ í™•ì¸í•´ì•¼ í•œë‹¤.
- Java 17 ì´ìƒì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
- javax íŒ¨í‚¤ì§€ ì´ë¦„ì„ jakartaë¡œ ë³€ê²½í•´ì•¼ í•œë‹¤.
  - ì˜¤ë¼í´ê³¼ ìë°” ë¼ì´ì„ ìŠ¤ ë¬¸ì œë¡œ ëª¨ë“  javax íŒ¨í‚¤ì§€ë¥¼ jakartaë¡œ ë³€ê²½
  - ex. JPA ì–´ë…¸í…Œì´ì…˜: javax.persistence.Entity -> jakarta.persistence.Entity
```

- - -
## âœ” ì˜ˆì œ í”„ë¡œì íŠ¸ ë§Œë“¤ê¸° -V0
- ìƒí’ˆ ì£¼ë¬¸ í”„ë¡œì„¸ìŠ¤
- Controller -> Service > Repositoryë¡œ ì´ì–´ì§€ëŠ” íë¦„

### 1. OrderRepositoryV0
java > hello.advanced.app.v0 > OrderRepositoryV0.java (class)
```java
package hello.advanced.app.v0;

import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;


@Repository
@RequiredArgsConstructor
public class OrderRepositoryV0 {

    // ì €ì¥ ë¡œì§
    public void save(String itemId) {
        if (itemId.equals("ex")) {
            throw new IllegalStateException("ì˜ˆì™¸ ë°œìƒ!");
        }
        sleep(1000); // 1ì´ˆ
    }

    private void sleep(int millies) {
        try {
            Thread.sleep(millies);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}

```
- `@Repository` : ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ì˜ ëŒ€ìƒì´ ëœë‹¤. ë”°ë¼ì„œ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ìë™ ë“±ë¡ëœë‹¤.
- `sleep(1000)` : ë¦¬í¬ì§€í† ë¦¬ëŠ” ìƒí’ˆì„ ì €ì¥í•˜ëŠ”ë° ì•½ 1ì´ˆ ì •ë„ ê±¸ë¦¬ëŠ” ê²ƒìœ¼ë¡œ ê°€ì •í•˜ê¸° ìœ„í•´ 1ì´ˆ ì§€ì—°ì„ ì£¼ì—ˆë‹¤. (1000ms)
- ì˜ˆì™¸ê°€ ë°œìƒí•˜ëŠ” ìƒí™©ë„ í™•ì¸í•˜ê¸° ìœ„í•´ íŒŒë¼ë¯¸í„° itemIdì˜ ê°’ì´ "ex"ë¡œ ë„˜ì–´ì˜¤ë©´ `IllegalStateException` ì˜ˆì™¸ê°€ ë°œìƒí•˜ë„ë¡ í–ˆë‹¤.

### 2. OrderServiceV0
java > hello.advanced.app.v0 > OrderServiceV0.java (class)
```java
package hello.advanced.app.v0;

import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class OrderServiceV0 {
    private final OrderRepositoryV0 orderRepository;
    
    public void orderItem(String itemId) {
        orderRepository.save(itemId);
    }
}

```
- `@Service` : ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ì˜ ëŒ€ìƒì´ ëœë‹¤.

### 3. OrderControllerV0
java > hello.advanced.app.v0 > OrderControllerV0.java (class)
```java
package hello.advanced.app.v0;

import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequiredArgsConstructor
public class OrderControllerV0 {
    private final OrderServiceV0 orderService;
    
    @GetMapping("/v0/request")
    public String request(String itemId) {
        orderService.orderItem(itemId);
        return "ok";
    }
}

```
- `@RestController` : ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ê³¼ ìŠ¤í”„ë§ Rest ì»¨íŠ¸ë¡¤ëŸ¬ë¡œ ì¸ì‹ëœë‹¤.
- `/v0/request` ë©”ì„œë“œëŠ” HTTP íŒŒë¼ë¯¸í„°ë¡œ `itemId`ë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤.

### 4. ì‹¤í–‰
#### ğŸ’¡ itemIdê°€ helloì¼ ê²½ìš°
http://localhost:8080/v0/request?itemId=hello

![hello](https://user-images.githubusercontent.com/54324782/222025323-a29a619b-3419-4370-87a5-1d717ac1b785.png)

#### ğŸ’¡ itemIdê°€ exì¼ ê²½ìš° - ì˜ˆì™¸ ë°œìƒ
http://localhost:8080/v0/request?itemId=ex

![ex](https://user-images.githubusercontent.com/54324782/222025391-e3158296-edcb-4ffa-9226-68e4b41e0d43.png)
![ì˜ˆì™¸ ë°œìƒ](https://user-images.githubusercontent.com/54324782/222025433-1cb97588-27bd-4381-9220-a0a9d0e0a69a.png)


- - -
## âœ” ë¡œê·¸ ì¶”ì ê¸° - ìš”êµ¬ì‚¬í•­ ë¶„ì„
### 1. ìš”êµ¬ì‚¬í•­
- ëª¨ë“  PUBLIC ë©”ì„œë“œì˜ í˜¸ì¶œê³¼ ì‘ë‹µ ì •ë³´ë¥¼ ë¡œê·¸ë¡œ ì¶œë ¥
- ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ íë¦„ì„ ë³€ê²½í•˜ë©´ ì•ˆë¨
  - ë¡œê·¸ë¥¼ ë‚¨ê¸´ë‹¤ê³  í•´ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ ë™ì‘ì— ì˜í–¥ì„ ì£¼ë©´ ì•ˆë¨
- ë©”ì„œë“œ í˜¸ì¶œì— ê±¸ë¦° ì‹œê°„
- ì •ìƒ íë¦„ê³¼ ì˜ˆì™¸ íë¦„ êµ¬ë¶„
  - ì˜ˆì™¸ ë°œìƒì‹œ ì˜ˆì™¸ ì •ë³´ê°€ ë‚¨ì•„ì•¼ í•¨
- ë©”ì„œë“œ í˜¸ì¶œì˜ ê¹Šì´ í‘œí˜„
- HTTP ìš”ì²­ì„ êµ¬ë¶„
  - HTTP ìš”ì²­ ë‹¨ìœ„ë¡œ íŠ¹ì • IDë¥¼ ë‚¨ê²¨ì„œ ì–´ë–¤ HTTP ìš”ì²­ ì—ì„œ ì‹œì‘ëœ ê²ƒì¸ì§€ ëª…í™•í•˜ê²Œ êµ¬ë¶„ì´ ê°€ëŠ¥í•´ì•¼ í•¨
  - íŠ¸ëœì­ì…˜ ID (DB íŠ¸ëœì­ì…˜X), ì—¬ê¸°ì„œëŠ” í•˜ë‚˜ì˜ HTTP ìš”ì²­ì´ ì‹œì‘í•´ì„œ ëë‚  ë•Œ ê¹Œì§€ë¥¼ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì´ë¼ í•¨

### 2. ì˜ˆì‹œ
```
ì •ìƒ ìš”ì²­
[796bccd9] OrderController.request()
[796bccd9] |-->OrderService.orderItem()
[796bccd9] | |-->OrderRepository.save()
[796bccd9] | |<--OrderRepository.save() time=1004ms
[796bccd9] |<--OrderService.orderItem() time=1014ms
[796bccd9] OrderController.request() time=1016ms

ì˜ˆì™¸ ë°œìƒ
[b7119f27] OrderController.request()
[b7119f27] |-->OrderService.orderItem()
[b7119f27] | |-->OrderRepository.save()
[b7119f27] | |<X-OrderRepository.save() time=0ms
ex=java.lang.IllegalStateException: ì˜ˆì™¸ ë°œìƒ!
[b7119f27] |<X-OrderService.orderItem() time=10ms
ex=java.lang.IllegalStateException: ì˜ˆì™¸ ë°œìƒ!
[b7119f27] OrderController.request() time=11ms
ex=java.lang.IllegalStateException: ì˜ˆì™¸ ë°œìƒ!
```

- - -
## âœ” ë¡œê·¸ ì¶”ì ê¸° V1 - í”„ë¡œí† íƒ€ì… ê°œë°œ
#### ë¡œê·¸ ì¶”ì ê¸°ë¥¼ ìœ„í•œ ê¸°ë°˜ ë°ì´í„°ë¥¼ ê°€ì§€ê³  ìˆëŠ” `TraceId`, `TraceStatus` í´ë˜ìŠ¤ ìƒì„±
### 1. TraceId
java > hello.advanced.trace > TraceId.java (class)
```java
package hello.advanced.trace;

import java.util.UUID;

public class TraceId {
    private String id;
    private int level;
    
    public TraceId() {
        this.id = createId();
        this.level = 0;
    }
    
    private TraceId(String id, int level) {
        this.id = id;
        this.level = level;
    }
    
    private String createId() {
        return UUID.randomUUID().toString().substring(0, 8);
    }
    
    public TraceId createNextId() {
        return new TraceId(id, level + 1);
    }
    
    public TraceId createPreviousId() {
        return new TraceId(id, level - 1);
    }
    
    public boolean isFirstLevel() {
        return level == 0;
    }
    
    public String getId() {
        return id;
    }
    
    public int getLevel() {
        return level;
    }
}
```

#### ğŸ’¡ TraceId í´ë˜ìŠ¤
- ë¡œê·¸ ì¶”ì ê¸°ëŠ” íŠ¸ëœì­ì…˜ IDì™€ ê¹Šì´ë¥¼ í‘œí˜„í•˜ëŠ” ë°©ë²•ì´ í•„ìš”í•˜ë‹¤.
- ì—¬ê¸°ì„œëŠ” íŠ¸ëœì­ì…˜IDì™€ ê¹Šì´ë¥¼ í‘œí˜„í•˜ëŠ” levelì„ ë¬¶ì–´ì„œ `TraceId`ë¼ëŠ” ê°œë…ì„ ë§Œë“¤ì—ˆë‹¤.
- `TraceId`ëŠ” ë‹¨ìˆœíˆ id(íŠ¸ëœì­ì…˜ID)ì™€ level ì •ë³´ë¥¼ í•¨ê»˜ ê°€ì§€ê³  ìˆë‹¤.
```
[796bccd9] OrderController.request() //íŠ¸ëœì­ì…˜ID:796bccd9, level:0
[796bccd9] |-->OrderService.orderItem() //íŠ¸ëœì­ì…˜ID:796bccd9, level:1
[796bccd9] | |-->OrderRepository.save()//íŠ¸ëœì­ì…˜ID:796bccd9, level:2
```
#### ğŸ’¡ UUID
- TraceIdë¥¼ ì²˜ìŒ ìƒì„±í•˜ë©´ createId() ë¥¼ ì‚¬ìš©í•´ì„œ UUIDë¥¼ ë§Œë“¤ì–´ë‚¸ë‹¤.
- ì—¬ê¸°ì„œëŠ” ì• 8ìë¦¬ë§Œ ì‚¬ìš©
```
ab99e16f-3cde-4d24-8241-256108c203a2 //ìƒì„±ëœ UUID
ab99e16f //ì• 8ìë¦¬ë§Œ ì‚¬ìš©
```
#### ğŸ’¡ createNextId()
- ë‹¤ìŒ TraceIdë¥¼ ë§Œë“ ë‹¤.
- ê¹Šì´ê°€ í•˜ë‚˜ ì¦ê°€í•˜ë©°, ê¹Šì´ê°€ ì¦ê°€í•´ë„ íŠ¸ëœì­ì…˜IDëŠ” ê°™ë‹¤.
- ì‹¤í–‰ ì½”ë“œ : `new TraceId(id, level + 1)`
- ë”°ë¼ì„œ createNextId()ë¥¼ ì‚¬ìš©í•´ì„œ í˜„ì¬ TraceIdë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹¤ìŒ TraceIdë¥¼ ë§Œë“¤ë©´ idëŠ” ê¸°ì¡´ê³¼ ê°™ê³ , levelì€ í•˜ë‚˜ ì¦ê°€í•œë‹¤.
```
[796bccd9] OrderController.request()
[796bccd9] |-->OrderService.orderItem() //íŠ¸ëœì­ì…˜IDê°€ ê°™ë‹¤. ê¹Šì´ëŠ” í•˜ë‚˜ ì¦ê°€í•œë‹¤.
```
#### ğŸ’¡ createPreviousId()
- createNextId()ì˜ ë°˜ëŒ€ ì—­í• ì„ í•œë‹¤.
- idëŠ” ê¸°ì¡´ê³¼ ê°™ê³ , levelì€ í•˜ë‚˜ ê°ì†Œí•œë‹¤.
#### ğŸ’¡ isFirstLevel()
- ì²« ë²ˆì§¸ ë ˆë²¨ ì—¬ë¶€ë¥¼ í¸ë¦¬í•˜ê²Œ í™•ì¸í•  ìˆ˜ ìˆëŠ” ë©”ì„œë“œ

### 2. TraceStatus
java > hello.advanced.trace > TraceStatus.java (class)
```java
package hello.advanced.trace;

public class TraceStatus {
    private TraceId traceId;
    private Long startTimeMs;
    private String message;
    
    public TraceStatus(TraceId traceId, Long startTimeMs, String message) {
        this.traceId = traceId;
        this.startTimeMs = startTimeMs;
        this.message = message;
    }
    
    public Long getStartTimeMs() {
        return startTimeMs;
    }
    
    public String getMessage() {
        return message;
    }
    
    public TraceId getTraceId() {
        return traceId;
    }
}

```

#### ğŸ’¡ TraceStatus í´ë˜ìŠ¤
- ë¡œê·¸ì˜ ìƒíƒœ ì •ë³´ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.
- `TraceStatus`ëŠ” ë¡œê·¸ë¥¼ ì‹œì‘í•  ë•Œì˜ ìƒíƒœ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©°, ì´ ìƒíƒœ ì •ë³´ëŠ” ë¡œê·¸ë¥¼ ì¢…ë£Œí•  ë•Œ ì‚¬ìš©ëœë‹¤.
- `traceId` : ë‚´ë¶€ì— íŠ¸ëœì­ì…˜IDì™€ levelì„ ê°€ì§€ê³  ìˆë‹¤.
- `startTimeMs` : ë¡œê·¸ ì‹œì‘ ì‹œê°„ì´ë©°, ë¡œê·¸ ì¢…ë£Œì‹œ ì´ ì‹œì‘ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘~ì¢…ë£Œê¹Œì§€ ì „ì²´ ìˆ˜í–‰ì‹œê°„ì„ êµ¬í•  ìˆ˜ ìˆë‹¤.
- `message` : ì‹œì‘ì‹œ ì‚¬ìš©í•œ ë©”ì‹œì§€ì´ë©°, ì´í›„ ë¡œê·¸ ì¢…ë£Œì‹œì—ë„ ì´ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©í•´ì„œ ì¶œë ¥í•œë‹¤.

### 3. ë¡œê·¸ ìƒì„± ë° ì²˜ë¦¬
- `TraceId`, `TraceStatus`ë¥¼ ì‚¬ìš©í•´ì„œ ì‹¤ì œ ë¡œê·¸ë¥¼ ìƒì„±í•˜ê³ , ì²˜ë¦¬í•˜ëŠ” ê¸°ëŠ¥ì„ ê°œë°œ

#### ğŸ’¡ HelloTraceV1
java > hello.advanced.trace.hellotrace > HelloTraceV1.java (class)
```java
package hello.advanced.trace.hellotrace;

import hello.advanced.trace.TraceId;
import hello.advanced.trace.TraceStatus;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

@Slf4j
@Component
public class HelloTraceV1 {
    private static final String START_PREFIX = "-->";
    private static final String COMPLETE_PREFIX = "<--";
    private static final String EX_PREFIX = "<X-";
    
    public TraceStatus begin(String message) {
        TraceId traceId = new TraceId();
        Long startTimeMs = System.currentTimeMillis();
        log.info("[{}] {}{}", traceId.getId(), addSpace(START_PREFIX, traceId.getLevel()), message);
        return new TraceStatus(traceId, startTimeMs, message);
    }
    
    public void end(TraceStatus status) {
        complete(status, null);
    }
    
    public void exception(TraceStatus status, Exception e) {
        complete(status, e);
    }
    
    private void complete(TraceStatus status, Exception e) {
        Long stopTimeMs = System.currentTimeMillis();
        long resultTimeMs = stopTimeMs - status.getStartTimeMs();
        TraceId traceId = status.getTraceId();
        if (e == null) {
            log.info("[{}] {}{} time={}ms", traceId.getId(), addSpace(COMPLETE_PREFIX, traceId.getLevel()), status.getMessage(), resultTimeMs);
        } else {
            log.info("[{}] {}{} time={}ms ex={}", traceId.getId(), addSpace(EX_PREFIX, traceId.getLevel()), status.getMessage(), resultTimeMs, e.toString());
        }
    }
    
    private static String addSpace(String prefix, int level) {
        StringBuilder sb = new StringBuilder();
        for (int i=0; i<level; i++) {
            sb.append((i == level - 1) ? "|" + prefix : "| ");
        }
        return sb.toString();
    }
    
}
```

- `HelloTraceV1`ì„ ì‚¬ìš©í•´ì„œ ì‹¤ì œ ë¡œê·¸ë¥¼ ì‹œì‘í•˜ê³  ì¢…ë£Œí•  ìˆ˜ ìˆë‹¤. ë˜í•œ, ë¡œê·¸ë¥¼ ì¶œë ¥í•˜ê³  ì‹¤í–‰ì‹œê°„ë„ ì¸¡ì •í•  ìˆ˜ ìˆë‹¤.
- `@Component` : ì‹±ê¸€í†¤ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•œë‹¤. ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ì˜ ëŒ€ìƒì´ ëœë‹¤.

#### ğŸ’¡ ê³µê°œ ë©”ì„œë“œ
ë¡œê·¸ ì¶”ì ê¸°ì—ì„œ ì‚¬ìš©ë˜ëŠ” ê³µê°œ ë©”ì„œë“œëŠ” 3ê°€ì§€ì´ë‹¤. (begin(..), end(..), exception(..))
- `TraceStatus begin(String message)`
  - ë¡œê·¸ë¥¼ ì‹œì‘í•œë‹¤.
  - ë¡œê·¸ ë©”ì‹œì§€ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ì„œ ì‹œì‘ ë¡œê·¸ë¥¼ ì¶œë ¥í•œë‹¤.
  - ì‘ë‹µ ê²°ê³¼ë¡œ í˜„ì¬ ë¡œê·¸ì˜ ìƒíƒœì¸ TraceStatusë¥¼ ë°˜í™˜í•œë‹¤.
- `void end(TraceStatus status)`
  - ë¡œê·¸ë¥¼ ì •ìƒ ì¢…ë£Œí•œë‹¤.
  - íŒŒë¼ë¯¸í„°ë¡œ ì‹œì‘ ë¡œê·¸ì˜ ìƒíƒœ(TraceStatus)ë¥¼ ì „ë‹¬ ë°›ëŠ”ë‹¤. ì´ ê°’ì„ í™œìš©í•´ì„œ ì‹¤í–‰ ì‹œê°„ì„ ê³„ì‚°í•˜ê³ , ì¢…ë£Œì‹œì—ë„ ì‹œì‘í•  ë•Œì™€ ë™ì¼í•œ ë¡œê·¸ ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•  ìˆ˜ ìˆë‹¤.
  - ì •ìƒ íë¦„ì—ì„œ í˜¸ì¶œí•œë‹¤.
- `void exception(TraceStatus status, Exception e)`
  - ë¡œê·¸ë¥¼ ì˜ˆì™¸ ìƒí™©ìœ¼ë¡œ ì¢…ë£Œí•œë‹¤.
  - TraceStatus, Exception ì •ë³´ë¥¼ í•¨ê»˜ ì „ë‹¬ ë°›ì•„ì„œ ì‹¤í–‰ì‹œê°„, ì˜ˆì™¸ ì •ë³´ë¥¼ í¬í•¨í•œ ê²°ê³¼ ë¡œê·¸ë¥¼ ì¶œë ¥í•œë‹¤.
  - ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ í˜¸ì¶œí•œë‹¤.

#### ğŸ’¡ ë¹„ê³µê°œ ë©”ì„œë“œ
- `complete(TraceStatus status, Exception e)`
  - `end()`, `exception()`ì˜ ìš”ì²­ íë¦„ì„ í•œê³³ì—ì„œ í¸ë¦¬í•˜ê²Œ ì²˜ë¦¬í•œë‹¤. ì‹¤í–‰ ì‹œê°„ì„ ì¸¡ì •í•˜ê³  ë¡œê·¸ë¥¼ ë‚¨ê¸´ë‹¤.
- `String addSpace(String prefix, int level)`
  - ë‹¤ìŒê³¼ ê°™ì€ ê²°ê³¼ë¥¼ ì¶œë ¥

```
prefix: "-->"
- level 0 :
- level 1 : "|-->"
- level 2 : "|   |-->"

prefix: "<--"
- level 0 :
- level 1 : "|<--"
- level 2 : "|   |<--"

prefix: "<X-"
- level 0 :
- level 1 : "|<X-"
- level 2 : "|   |<x-"
```

### 4. í…ŒìŠ¤íŠ¸ ì‘ì„±
test > java > hello.advanced.trace.hellotrace > HelloTraceV1Test.java (class)
```java
package hello.advanced.trace.hellotrace;

import hello.advanced.trace.TraceStatus;
import org.junit.jupiter.api.Test;

public class HelloTraceV1Test {
    @Test
    void begin_end() {
        HelloTraceV1 trace = new HelloTraceV1();
        TraceStatus status = trace.begin("hello");
        trace.end(status);
    }
    
    @Test
    void begin_exception() {
        HelloTraceV1 trace = new HelloTraceV1();
        TraceStatus status = trace.begin("hello");
        trace.exception(status, new IllegalStateException());
    }
}

```
```
// begin_end() ì‹¤í–‰ ë¡œê·¸
13:04:07.880 [Test worker] INFO hello.advanced.trace.hellotrace.HelloTraceV1 - [90b03594] hello
13:04:07.891 [Test worker] INFO hello.advanced.trace.hellotrace.HelloTraceV1 - [90b03594] hello time=14ms
// begin_exception() ì‹¤í–‰ ë¡œê·¸
13:04:59.192 [Test worker] INFO hello.advanced.trace.hellotrace.HelloTraceV1 - [6ad3088a] hello
13:04:59.208 [Test worker] INFO hello.advanced.trace.hellotrace.HelloTraceV1 - [6ad3088a] hello time=20ms ex=java.lang.IllegalStateException
```

- - -
## âœ” ë¡œê·¸ ì¶”ì ê¸° V1 - ì ìš©
- `hello.advanced.app.v1` íŒ¨í‚¤ì§€ ìƒì„±
- ë³µì‚¬
  - v0.OrderRepositoryV0 --> v1.OrderRepositoryV1
  - v0.OrderServiceV0 --> v1.OrderServiceV1
  - v0.OrderControllerV0 --> v1.OrderControllerV1
- ì½”ë“œ ë‚´ë¶€ ì˜ì¡´ê´€ê³„ í´ë˜ìŠ¤ë¥¼ V1ìœ¼ë¡œ ë³€ê²½
  - OrderControllerV1 : OrderServiceV0 --> OrderServiceV1
  - OrderServiceV1 : OrderRepositoryV0 --> OrderRepositoryV1
- OrderControllerV1 ë§¤í•‘ ì •ë³´ ë³€ê²½
  - `@GetMapping("/v1/request")`
- ì •ìƒ ë™ì‘ í™•ì¸
![image](https://user-images.githubusercontent.com/54324782/225916292-9524abb6-c025-42d0-8490-eee19c1c73b3.png)

### 1. v1 ì ìš©í•˜ê¸°
- `OrderControllerV1`, `OrderServiceV1`, `OrderRepositoryV1`ì— ë¡œê·¸ ì¶”ì ê¸°ë¥¼ ì ìš©
#### (1) OrderControllerV1 - HelloTraceV1 ì ìš©
```java
package hello.advanced.app.v1;

import hello.advanced.trace.TraceStatus;
import hello.advanced.trace.hellotrace.HelloTraceV1;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequiredArgsConstructor
public class OrderControllerV1 {
    private final OrderServiceV1 orderService;
    private final HelloTraceV1 trace;

    @GetMapping("/v1/request")
    public String request(String itemId) {

        TraceStatus status = null;
        try {
            status = trace.begin("OrderController.request()");
            orderService.orderItem(itemId);
            trace.end(status);
            return "ok";
        } catch (Exception e) {
            trace.exception(status, e);
            throw e; // ì˜ˆì™¸ë¥¼ ê¼­ ë‹¤ì‹œ ë˜ì ¸ì£¼ì–´ì•¼ í•œë‹¤.
        }
    }
}
```
```
1) HelloTraceV1 trace
HelloTraceV1ì„ ì£¼ì…ë°›ëŠ”ë‹¤. HelloTraceV1ì€ @Component ì–´ë…¸í…Œì´ì…˜ì„ ê°–ê³  ìˆê¸° ë•Œë¬¸ì— ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ì˜ ëŒ€ìƒì´ ëœë‹¤.
ë”°ë¼ì„œ, ìë™ìœ¼ë¡œ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡ëœë‹¤.
2) trace.begin("OrderController.request()")
ë¡œê·¸ë¥¼ ì‹œì‘í•  ë•Œì˜ ë©”ì‹œì§€ ì´ë¦„ì„ ì»¨íŠ¸ë¡¤ëŸ¬ ì´ë¦„ + ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì§€ì •í•œë‹¤.
  - ë‹¨ìˆœíˆ trace.begin(), trace.end() ì½”ë“œë§Œ ì ìš©í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, trace.exception()ìœ¼ë¡œ ì˜ˆì™¸ê¹Œì§€ ì²˜ë¦¬í•´ì•¼ í•˜ë¯€ë¡œ
    try, catch ì½”ë“œê°€ ì¶”ê°€ëœë‹¤.
  - begin()ì˜ ê²°ê³¼ ê°’ìœ¼ë¡œ ë°›ì€ TraceStatus status ê°’ì„ end(), exception()ì— ë„˜ê²¨ì•¼ í•œë‹¤.
    ê²°êµ­ try, catch ë¸”ë¡ ëª¨ë‘ì— ì´ ê°’ì„ ë„˜ê²¨ì•¼ í•œë‹¤. ë”°ë¼ì„œ try ìƒìœ„ì— TraceStatus status ì½”ë“œë¥¼ ì„ ì–¸í•´ì•¼ í•œë‹¤.
    ë§Œì•½ try ì•ˆì—ì„œ TraceStatus statusë¥¼ ì„ ì–¸í•˜ë©´ try ë¸”ë¡ ì•ˆì—ì„œë§Œ í•´ë‹¹ ë³€ìˆ˜ê°€ ìœ íš¨í•˜ê¸° ë•Œë¬¸ì— catch ë¸”ë¡ì— ë„˜ê¸¸ ìˆ˜ ì—†ë‹¤.(ì»´íŒŒì¼ ì˜¤ë¥˜ ë°œìƒ)
3) throw e
ì˜ˆì™¸ë¥¼ ê¼­ ë‹¤ì‹œ ë˜ì ¸ì£¼ì–´ì•¼ í•œë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì—¬ê¸°ì„œ ì˜ˆì™¸ë¥¼ ë¨¹ì–´ë²„ë¦¬ê³ , ì´í›„ì— ì •ìƒ íë¦„ìœ¼ë¡œ ë™ì‘í•œë‹¤.
ë¡œê·¸ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ íë¦„ì— ì˜í–¥ì„ ì£¼ë©´ ì•ˆëœë‹¤. ë¡œê·¸ ë•Œë¬¸ì— ì˜ˆì™¸ê°€ ì‚¬ë¼ì§€ë©´ ì•ˆëœë‹¤.
```
#### ğŸ’¡ ì‹¤í–‰
- ì •ìƒ: http://localhost:8080/v1/request?itemId=hello
![ì •ìƒ](https://user-images.githubusercontent.com/54324782/225920640-35b6dcdc-effb-4229-92fb-aabea2597596.png)
```
2023-03-17 22:39:52.124  INFO 22152 --- [nio-8080-exec-7] h.a.trace.hellotrace.HelloTraceV1        : [4d4ea6fc] OrderController.request()
2023-03-17 22:39:53.140  INFO 22152 --- [nio-8080-exec-7] h.a.trace.hellotrace.HelloTraceV1        : [4d4ea6fc] OrderController.request() time=1016ms
```

- ì˜ˆì™¸: http://localhost:8080/v1/request?itemId=ex
![ì˜ˆì™¸](https://user-images.githubusercontent.com/54324782/225920705-e22d967b-c783-4a86-88c7-171c4a72ed1b.png)
```
2023-03-17 22:41:27.470  INFO 22152 --- [io-8080-exec-10] h.a.trace.hellotrace.HelloTraceV1        : [53296d33] OrderController.request()
2023-03-17 22:41:27.470  INFO 22152 --- [io-8080-exec-10] h.a.trace.hellotrace.HelloTraceV1        : [53296d33] OrderController.request() time=0ms ex=java.lang.IllegalStateException: ì˜ˆì™¸ ë°œìƒ!
2023-03-17 22:41:27.473 ERROR 22152 --- [io-8080-exec-10] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.IllegalStateException: ì˜ˆì™¸ ë°œìƒ!] with root cause
```

#### (2) OrderServiceV1
```java
package hello.advanced.app.v1;

import hello.advanced.trace.TraceStatus;
import hello.advanced.trace.hellotrace.HelloTraceV1;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class OrderServiceV1 {
    private final OrderRepositoryV1 orderRepository;
    private final HelloTraceV1 trace;

    public void orderItem(String itemId) {
        TraceStatus status = null;
        try {
            status = trace.begin("OrderService.orderItem()");
            orderRepository.save(itemId);
            trace.end(status);
        } catch (Exception e) {
            trace.exception(status, e);
            throw e;
        }
    }
}
```

#### (3) OrderRepositoryV1
```java
package hello.advanced.app.v1;

import hello.advanced.trace.TraceStatus;
import hello.advanced.trace.hellotrace.HelloTraceV1;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;


@Repository
@RequiredArgsConstructor
public class OrderRepositoryV1 {
    private final HelloTraceV1 trace;

    // ì €ì¥ ë¡œì§
    public void save(String itemId) {
        TraceStatus status = null;
        try {
            status = trace.begin("OrderRepository.save()");
            
            // ì €ì¥ ë¡œì§
            if (itemId.equals("ex")) {
                throw new IllegalStateException("ì˜ˆì™¸ ë°œìƒ!");
            }
            sleep(1000); // 1ì´ˆ
            
            trace.end(status);
        } catch (Exception e) {
            trace.exception(status, e);
            throw e;
        }
    }

    private void sleep(int millies) {
        try {
            Thread.sleep(millies);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```
#### ğŸ’¡ ì •ìƒ ì‹¤í–‰ ë¡œê·¸
- http://localhost:8080/v1/request?itemId=hello
```
[780a3699] OrderController.request()
[4e089b5f] OrderService.orderItem()
[b567b92e] OrderRepository.save()
[b567b92e] OrderRepository.save() time=1008ms
[4e089b5f] OrderService.orderItem() time=1010ms
[780a3699] OrderController.request() time=1016ms
```
![image](https://user-images.githubusercontent.com/54324782/225923618-e33570a8-b8e4-4a6a-ad33-b968505b6dd4.png)

#### ğŸ’¡ ì˜ˆì™¸ ì‹¤í–‰ ë¡œê·¸
- http://localhost:8080/v1/request?itemId=ex
```
[fb98da11] OrderController.request()
[fad34992] OrderService.orderItem()
[acfca564] OrderRepository.save()
[acfca564] OrderRepository.save() time=0ms ex=java.lang.IllegalStateException: ì˜ˆì™¸ ë°œìƒ!
[fad34992] OrderService.orderItem() time=1ms ex=java.lang.IllegalStateException: ì˜ˆì™¸ ë°œìƒ!
[fb98da11] OrderController.request() time=2ms ex=java.lang.IllegalStateException: ì˜ˆì™¸ ë°œìƒ!
```

### 2. ë‚¨ì€ ë¬¸ì œ (ìš”êµ¬ì‚¬í•­)
- ~~ëª¨ë“  PUBLIC ë©”ì„œë“œì˜ í˜¸ì¶œê³¼ ì‘ë‹µ ì •ë³´ë¥¼ ë¡œê·¸ë¡œ ì¶œë ¥~~
- ~~ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ íë¦„ì„ ë³€ê²½í•˜ë©´ ì•ˆë¨~~
  - ~~ë¡œê·¸ë¥¼ ë‚¨ê¸´ë‹¤ê³  í•´ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ ë™ì‘ì— ì˜í–¥ì„ ì£¼ë©´ ì•ˆë¨~~
- ~~ë©”ì„œë“œ í˜¸ì¶œì— ê±¸ë¦° ì‹œê°„~~
- ~~ì •ìƒ íë¦„ê³¼ ì˜ˆì™¸ íë¦„ êµ¬ë¶„~~
  - ~~ì˜ˆì™¸ ë°œìƒ ì‹œ ì˜ˆì™¸ ì •ë³´ê°€ ë‚¨ì•„ì•¼ í•¨~~

- ë©”ì„œë“œì˜ í˜¸ì¶œì˜ ê¹Šì´ í‘œí˜„
- HTTP ìš”ì²­ì„ êµ¬ë¶„
  - HTTP ìš”ì²­ ë‹¨ìœ„ë¡œ íŠ¹ì • IDë¥¼ ë‚¨ê²¨ì„œ ì–´ë–¤ HTTP ìš”ì²­ì—ì„œ ì‹œì‘ëœ ê²ƒì¸ì§€ ëª…í™•í•˜ê²Œ êµ¬ë¶„ì´ ê°€ëŠ¥í•´ì•¼ í•¨
  - íŠ¸ëœì­ì…˜ ID (DB íŠ¸ëœì­ì…˜ X)


- - -
## âœ” ë¡œê·¸ ì¶”ì ê¸° V2 - íŒŒë¼ë¯¸í„°ë¡œ ë™ê¸°í™” ê°œë°œ
